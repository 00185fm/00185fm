version: "3.8"

services:
  ################ TRAEFIK
  traefik:
    image: traefik:v2.10.4
    container_name: traefik
    restart: unless-stopped
    security_opt:
      - no-new-privileges:true
    command:
      # We are going to use the docker provider
      - "--providers.docker"
      # Only enabled containers should be exposed
      - "--providers.docker.exposedByDefault=false"
      # Disabling the dashbaord
      - "--api.dashboard=false"
      - "--api.insecure=false"
      # The entrypoints we want to expose
      - "--entrypoints.web.address=:80"
      - "--entrypoints.websecure.address=:443"
      # Enable ACME (Let's Encrypt): automatic SSL.
      - "--certificatesresolvers.letsencrypt.acme.email=stortinomanfrotto@gmail.com"
      - "--certificatesresolvers.letsencrypt.acme.storage=/acme.json"
      - "--certificatesresolvers.letsencrypt.acme.httpchallenge=true"
      - "--certificatesresolvers.letsencrypt.acme.httpchallenge.entrypoint=web"
      # Global redirect to https
      - "--entrypoints.web.http.redirections.entryPoint.to=websecure"
      - "--entrypoints.web.http.redirections.entryPoint.scheme=https"
    networks:
      - traefik-net
    ports:
      - 80:80
      - 443:443
    volumes:
      - /etc/localtime:/etc/localtime:ro
      - /var/run/docker.sock:/var/run/docker.sock:ro
      - ./traefik/acme.json:/acme.json

  ################ POCKETBASE
  pocketbase:
    build:
      context: ./pocketbase
      args:
        - PB_PORT
    command: ["./pocketbase", "serve", "--http=0.0.0.0:${PB_PORT}"]
    container_name: pocketbase
    restart: always
    networks:
      - traefik-net
    ports:
      - ${PB_PORT}:${PB_PORT}
    volumes:
      - ./pocketbase/pb_data:/pb/pb_data
      - ./pocketbase/pb_hooks:/pb/pb_hooks
      - ./pocketbase/pb_public:/pb/pb_public
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.pb.rule=Host(`pb.00185fm.eu`)"
      - "traefik.http.routers.pb.entrypoints=web"
      - "traefik.http.routers.pb-secure.tls=true"
      - "traefik.http.routers.pb-secure.tls.certresolver=letsencrypt"
      - "traefik.http.services.pb.loadbalancer.server.port=${PB_PORT}"
      - "traefik.http.middlewares.pb.redirectscheme.scheme=https"
      - "traefik.http.middlewares.pb-https-redirect.redirectscheme.scheme=https"
      - "traefik.http.routers.pb.middlewares=pb-https-redirect"
      - "traefik.http.routers.pb-secure.entrypoints=websecure"
      - "traefik.http.routers.pb-secure.rule=Host(`pb.00185fm.eu`)"
      - "traefik.docker.network=traefik-net"
    healthcheck: #optional (recommended) since v0.10.0
      test: wget --no-verbose --tries=1 --spider http://localhost:4090/api/health || exit 1
      interval: 5s
      timeout: 5s
      retries: 5

  ################ ICECAST
  icecast:
    image: moul/icecast
    container_name: icecast
    restart: always
    volumes:
      - logs:/var/log/icecast2
      - /etc/localtime:/etc/localtime:ro
    environment:
      - VIRTUAL_HOST=${ICECAST_HOSTNAME:-localhost}
      - ICECAST_SOURCE_PASSWORD
      - ICECAST_ADMIN_PASSWORD
      - ICECAST_PASSWORD
      - ICECAST_RELAY_PASSWORD
    networks:
      - traefik-net
    ports:
      - ${ICECAST_PORT:-4040}:8000
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.icecast.rule=Host(`ice.00185fm.eu`)"
      - "traefik.http.routers.icecast.entrypoints=web"
      - "traefik.http.routers.icecast-secure.tls=true"
      - "traefik.http.routers.icecast-secure.tls.certresolver=letsencrypt"
      - "traefik.http.services.icecast.loadbalancer.server.port=8000"
      - "traefik.http.middlewares.icecast.redirectscheme.scheme=https"
      - "traefik.http.middlewares.icecast-https-redirect.redirectscheme.scheme=https"
      - "traefik.http.routers.icecast.middlewares=icecast-https-redirect"
      - "traefik.http.routers.icecast-secure.entrypoints=websecure"
      - "traefik.http.routers.icecast-secure.rule=Host(`ice.00185fm.eu`)"
      - "traefik.docker.network=traefik-net"

  ################ LIQUIDSOAP
  liquidsoap:
    image: "savonet/liquidsoap-alpine:v2.1.4"
    container_name: liquidsoap
    restart: always
    command: ["/settings.liq"]
    environment:
      - ICECAST_HOSTNAME
      - ICECAST_SOURCE_PASSWORD
      - STREAM_NAME
      - STREAM_DESC
      - STREAM_URL
      - STREAM_MOUNTPOINT
      - LIVE_PASSWORD
      - LIVE_MOUNTPOINT
    depends_on:
      - pocketbase
      - icecast
    networks:
      - traefik-net
    ports:
      - "${LIVE_PORT:-4080}:4080"
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.liquidsoap.rule=Host(`liq.00185fm.eu`)"
      - "traefik.http.routers.liquidsoap.entrypoints=web"
      - "traefik.http.routers.liquidsoap-secure.tls=true"
      - "traefik.http.routers.liquidsoap-secure.tls.certresolver=letsencrypt"
      - "traefik.http.services.liquidsoap.loadbalancer.server.port=${LIVE_PORT}"
      - "traefik.http.middlewares.liquidsoap.redirectscheme.scheme=https"
      - "traefik.http.middlewares.liquidsoap-https-redirect.redirectscheme.scheme=https"
      - "traefik.http.routers.liquidsoap.middlewares=liquidsoap-https-redirect"
      - "traefik.http.routers.liquidsoap-secure.entrypoints=websecure"
      - "traefik.http.routers.liquidsoap-secure.rule=Host(`liq.00185fm.eu`)"
      - "traefik.docker.network=traefik-net"
    volumes:
      - ./pocketbase/pb_public/:/pb_public:ro
      - ./liquidsoap/settings.liq:/settings.liq:ro

  ################ FRONTEND
  app:
    build:
      context: ./app
      args:
        - PUBLIC_NP_ID
        - PUBLIC_DEF_PLAYLIST_ID
        - PUBLIC_POCKETBASE_URL
        - PUBLIC_DEFAUL_ART
        - PUBLIC_RADIO_URL
        - PRIVATE_ICECAST
    container_name: app
    restart: always
    environment:
      - ORIGIN
      - BODY_SIZE_LIMIT=0
      - PUBLIC_NP_ID
      - PUBLIC_DEF_PLAYLIST_ID
      - PUBLIC_POCKETBASE_URL
      - PUBLIC_DEFAUL_ART
      - PUBLIC_RADIO_URL
      - PRIVATE_ICECAST
    networks:
      - traefik-net
    ports:
      - "4000:4000"
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.app.rule=Host(`dev.00185fm.eu`)"
      - "traefik.http.routers.app.entrypoints=web"
      - "traefik.http.routers.app-secure.tls=true"
      - "traefik.http.routers.app-secure.tls.certresolver=letsencrypt"
      - "traefik.http.services.app.loadbalancer.server.port=4000"
      - "traefik.http.middlewares.app.redirectscheme.scheme=https"
      - "traefik.http.middlewares.app-https-redirect.redirectscheme.scheme=https"
      - "traefik.http.routers.app.middlewares=app-https-redirect"
      - "traefik.http.routers.app-secure.entrypoints=websecure"
      - "traefik.http.routers.app-secure.rule=Host(`dev.00185fm.eu`)"
      - "traefik.docker.network=traefik-net"
    depends_on:
      - pocketbase
      - liquidsoap
      - icecast

volumes:
  logs:

networks:
  traefik-net:
